<!DOCTYPE html>
<html lang="fa" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Forensics | رصدخانه ناهنجاری‌ها</title>
    <meta name="description" content="لیست حساب‌های کاربری توییتر با الگوی اتصال غیرعادی از ایران.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTML2Canvas (For Report Generation) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@33.003/misc/Farsi-Digits/Vazirmatn-FD-font-face.css" rel="stylesheet" type="text/css" />

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Vazirmatn', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    colors: {
                        slate: { 850: '#151f32', 950: '#020617' }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Vazirmatn', sans-serif; }
        input, select, button, textarea { font-family: 'Vazirmatn', sans-serif !important; }
        .dir-ltr { direction: ltr; text-align: left; }
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen flex flex-col font-sans overflow-x-hidden">

    <!-- Lightbox Overlay -->
    <div id="lightbox" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4 cursor-zoom-out transition-opacity duration-300 opacity-0">
        <img id="lightbox-img" src="" class="max-w-full max-h-full rounded-lg shadow-2xl transform scale-95 transition-transform duration-300" alt="Zoomed Avatar">
        <button onclick="closeLightbox()" class="absolute top-6 right-6 p-3 bg-white/10 rounded-full text-white hover:bg-white/20 transition-colors">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>

    <!-- Tutorial Modal (Lazy Loaded Video) -->
    <div id="tutorial-modal" class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-slate-950/90 backdrop-blur-md p-4 transition-opacity" onclick="if(event.target===this) toggleTutorial(false)">
        <div class="relative w-full max-w-5xl bg-black rounded-3xl overflow-hidden shadow-2xl border border-white/10 flex flex-col h-[70vh] md:h-[80vh]">
            <div class="flex justify-between items-center p-4 bg-slate-900/80 border-b border-white/10 shrink-0 z-10">
                <span class="text-white font-bold text-sm">راهنمای استفاده</span>
                <button onclick="toggleTutorial(false)" class="text-white/70 hover:text-white bg-white/10 hover:bg-red-600 rounded-full p-2 transition-colors"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="flex-grow bg-black relative w-full overflow-hidden">
                <!-- Video tag is empty initially to prevent download on load -->
                <video id="tutorial-video" controls playsinline class="absolute inset-0 w-full h-full object-contain focus:outline-none"></video>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-red-600 to-orange-500 rounded-lg flex items-center justify-center font-bold text-white font-sans text-xl shadow-lg shadow-red-500/20">X</div>
                    <span class="font-bold text-lg tracking-tight text-white">Forensics <span class="text-slate-500 text-sm font-normal">Cloud</span></span>
                </div>
                <div class="flex gap-4">
                    <button onclick="toggleTutorial(true)" class="text-sm text-slate-300 hover:text-white flex items-center gap-2 font-medium">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="hidden sm:inline">آموزش</span>
                    </button>
                    <a href="https://github.com/itsyebekhe/xforensics" target="_blank" class="text-sm text-slate-300 hover:text-white flex items-center gap-2 font-medium">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        <span class="hidden sm:inline">GitHub</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Hero Section -->
        <div class="relative bg-slate-900 text-white rounded-[2.5rem] p-8 md:p-12 mb-8 overflow-hidden shadow-2xl shadow-slate-900/20 isolate">
            <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 32px 32px;"></div>
            <div class="absolute -right-20 -top-20 w-96 h-96 bg-blue-600 rounded-full blur-[100px] opacity-20 mix-blend-screen animate-pulse"></div>
            <div class="absolute -left-20 -bottom-20 w-80 h-80 bg-red-600 rounded-full blur-[100px] opacity-20 mix-blend-screen"></div>
            <div class="relative z-10 flex flex-col md:flex-row items-start md:items-center justify-between gap-8">
                <div>
                    <div class="flex items-center gap-3 mb-4"><span class="px-3 py-1 bg-red-500/20 text-red-300 border border-red-500/30 rounded-full text-xs font-bold tracking-wider uppercase animate-pulse">● System Live</span></div>
                    <h1 class="text-3xl md:text-5xl font-black tracking-tight mb-4">X <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-orange-400">Forensics</span></h1>
                    <p class="text-slate-400 text-base md:text-lg max-w-xl leading-relaxed">سامانه هوشمند شناسایی و تحلیل الگوهای اتصال غیرعادی (Direct Access) در شبکه اجتماعی ایکس.</p>
                </div>
                <div class="flex gap-4 md:gap-8 bg-white/5 backdrop-blur-sm p-6 rounded-3xl border border-white/10 w-full md:w-auto">
                    <div class="text-center"><div class="text-xs text-slate-400 mb-1">کل موارد</div><div class="text-3xl font-black text-white" id="header-stat-total">0</div></div>
                    <div class="w-px bg-white/10"></div>
                    <div class="text-center"><div class="text-xs text-slate-400 mb-1">اندروید</div><div class="text-3xl font-black text-green-400" id="header-stat-android">0</div></div>
                    <div class="w-px bg-white/10"></div>
                    <div class="text-center"><div class="text-xs text-slate-400 mb-1">آیفون</div><div class="text-3xl font-black text-blue-400" id="header-stat-iphone">0</div></div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-8">
            <div class="bg-slate-900/80 backdrop-blur-xl p-1.5 rounded-2xl border border-slate-800 flex gap-2 shadow-lg">
                <button onclick="switchView('list')" id="tab-list" class="px-6 py-2.5 rounded-xl text-sm font-bold transition-all bg-slate-800 text-white shadow-sm">رصدخانه (لیست)</button>
                <button onclick="switchView('analytics')" id="tab-analytics" class="px-6 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-400 hover:text-white hover:bg-white/5">تحلیل آماری</button>
                <button onclick="switchView('lookup')" id="tab-lookup" class="px-6 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-400 hover:text-white hover:bg-white/5">استعلام کاربر</button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="flex flex-col items-center justify-center py-20 gap-4">
            <div class="loader w-12 h-12 border-4"></div>
            <p class="text-slate-400 text-sm animate-pulse">در حال دریافت پایگاه داده...</p>
        </div>

        <!-- VIEWS CONTAINER -->
        <div id="app-content" class="hidden">
            
            <!-- VIEW 1: LIST / OBSERVATORY -->
            <div id="view-list" class="view-section">
                <!-- Toolbar -->
                <div class="sticky top-24 z-30 mb-8 transition-all duration-300">
                    <div class="bg-slate-900/80 backdrop-blur-xl border border-slate-800 p-2 rounded-[1.5rem] shadow-xl flex flex-col md:flex-row gap-2">
                        <div class="relative flex-grow group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-500"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                            <input type="text" id="search-input" placeholder="جستجوی نام کاربری، شناسه یا تاریخ..." class="w-full bg-slate-950 pl-12 pr-6 py-3.5 rounded-xl border border-transparent focus:bg-slate-950 focus:border-blue-500/50 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all text-sm font-medium text-white placeholder:text-slate-600">
                        </div>
                        <div class="flex gap-2">
                            <div class="relative min-w-[160px]">
                                <select id="sort-select" class="w-full appearance-none bg-slate-950 text-slate-300 font-bold text-sm rounded-xl py-3.5 px-4 pr-10 border border-transparent focus:border-slate-700 outline-none cursor-pointer transition-all">
                                    <option value="newest">جدیدترین (تاریخ)</option>
                                    <option value="oldest">قدیمی‌ترین (تاریخ)</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>
                            </div>
                            <button onclick="exportCSV()" class="p-3.5 bg-slate-950 text-slate-400 hover:text-green-500 hover:bg-slate-900 rounded-xl transition-all border border-transparent" title="Download CSV">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Grid -->
                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <!-- JS Injected Cards -->
                </div>

                <!-- Pagination -->
                <div id="pagination" class="flex justify-center items-center gap-4 mt-12 mb-8 text-sm text-slate-400 font-sans"></div>
            </div>

            <!-- VIEW 2: ANALYTICS -->
            <div id="view-analytics" class="view-section hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-10">
                    <div class="bg-slate-900 p-5 rounded-xl border border-slate-800">
                        <div class="text-xs text-slate-500 font-bold mb-1">کل موارد</div>
                        <div class="text-3xl font-black text-white" id="anl-total">0</div>
                    </div>
                    <div class="bg-green-900/10 p-5 rounded-xl border border-green-900/20">
                        <div class="text-xs text-green-500 font-bold mb-1">اندروید</div>
                        <div class="text-3xl font-black text-green-500" id="anl-android">0</div>
                    </div>
                    <div class="bg-blue-900/10 p-5 rounded-xl border border-blue-900/20">
                        <div class="text-xs text-blue-500 font-bold mb-1">آیفون</div>
                        <div class="text-3xl font-black text-blue-500" id="anl-iphone">0</div>
                    </div>
                    <div class="bg-slate-800 p-5 rounded-xl border border-slate-700">
                        <div class="text-xs text-slate-400 font-bold mb-1">وب / سایر</div>
                        <div class="text-3xl font-black text-slate-400" id="anl-web">0</div>
                    </div>
                </div>

                <div class="mb-10">
                    <h4 class="text-sm font-bold text-slate-400 mb-3">توزیع سیستم‌عامل</h4>
                    <div class="w-full h-4 bg-slate-800 rounded-full overflow-hidden flex mb-3 shadow-inner">
                        <div id="bar-android-pct" class="h-full bg-green-500 transition-all duration-1000" style="width: 0%"></div>
                        <div id="bar-iphone-pct" class="h-full bg-blue-500 transition-all duration-1000" style="width: 0%"></div>
                        <div id="bar-web-pct" class="h-full bg-slate-600 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-slate-500 font-mono">
                        <span id="lbl-android">0% Android</span>
                        <span id="lbl-iphone">0% iPhone</span>
                        <span id="lbl-web">0% Web</span>
                    </div>
                </div>

                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 mb-8">
                    <div class="flex items-center gap-2 mb-6">
                        <div class="w-1 h-5 bg-red-500 rounded-full"></div>
                        <h4 class="text-sm font-bold text-slate-200">شبکه‌های زمانی (Date Clusters)</h4>
                    </div>
                    <div id="clusters-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        <!-- JS Injected Clusters -->
                    </div>
                </div>

                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <div class="flex items-center gap-2 mb-6">
                        <div class="w-1 h-5 bg-blue-500 rounded-full"></div>
                        <h4 class="text-sm font-bold text-slate-200">توزیع سالانه (Yearly Timeline)</h4>
                    </div>
                    <div id="timeline-chart" class="flex items-end gap-3 h-48 overflow-x-auto pb-2 px-2 scrollbar-hide">
                        <!-- JS Injected Timeline -->
                    </div>
                </div>
            </div>

            <!-- VIEW 3: LOOKUP / SEARCH -->
            <div id="view-lookup" class="view-section hidden">
                <div class="max-w-2xl mx-auto text-center mb-10">
                    <label class="block text-slate-400 text-sm font-bold mb-4">نام کاربری (بدون @) یا شناسه عددی را وارد کنید:</label>
                    <div class="relative">
                        <input type="text" id="lookup-input" placeholder="مثال: elonmusk" class="w-full text-center text-xl font-bold bg-slate-900 py-5 px-6 rounded-2xl border-2 border-slate-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all dir-ltr placeholder:text-slate-600 text-white">
                        <button onclick="performLookup()" class="absolute left-3 top-3 bottom-3 bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-xl font-bold shadow-lg shadow-blue-600/20 transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            جستجو
                        </button>
                    </div>
                </div>

                <div id="lookup-result" class="max-w-md mx-auto">
                    <!-- JS Injected Result -->
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="mt-20 text-center text-xs text-slate-500 max-w-3xl mx-auto border-t border-slate-800 pt-8 leading-6 font-medium">
            <p class="mb-2 font-bold text-slate-300">⚠️ سلب مسئولیت حقوقی و فنی</p>
            <p>این اطلاعات صرفاً بر اساس داده‌های عمومی (Public API) شبکه اجتماعی ایکس استخراج شده است. وجود نام یک حساب در این لیست لزوماً به معنای وابستگی سازمانی نیست، اما نشان‌دهنده یک الگوی اتصال غیرعادی (اتصال مستقیم از ایران) است که می‌تواند ناشی از سیم‌کارت‌های خاص یا تانلینگ باشد.</p>
        </div>
    </main>

    <!-- HIDDEN EXPORT TEMPLATE (Fixed position offscreen to capture via Canvas) -->
    <div style="position: fixed; left: -2000px; top: 0; width: 600px; height: 600px; overflow: hidden; z-index: -1;">
        <div id="export-template" class="w-[600px] h-[600px] bg-slate-950 relative overflow-hidden flex flex-col justify-center items-center p-8 text-white font-sans">
            <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 24px 24px;"></div>
            <div class="absolute -top-32 -right-32 w-80 h-80 bg-red-600 rounded-full blur-[100px] opacity-30 mix-blend-screen"></div>
            <div class="absolute -bottom-32 -left-32 w-80 h-80 bg-blue-600 rounded-full blur-[100px] opacity-30 mix-blend-screen"></div>
            
            <div class="relative z-10 w-full bg-slate-900/80 backdrop-blur-md rounded-3xl border border-white/10 p-8 shadow-2xl">
                <div class="flex justify-between items-center mb-8 border-b border-white/5 pb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
                        <span id="exp-r" dir="rtl" class="text-sm font-bold tracking-widest text-red-500 uppercase" style="font-family: 'Vazirmatn', sans-serif; letter-spacing: 0px !important;">DETECTED</span>
                    </div>
                    <div class="text-xs text-slate-500 font-mono">FactZone X Forensics</div>
                </div>
                
                <div class="flex items-start gap-6 mb-4">
                    <img id="exp-a" src="" class="w-24 h-24 rounded-2xl border-4 border-slate-800 shadow-xl object-cover flex-shrink-0" crossorigin="anonymous">
                    <div class="flex-1 min-w-0 pt-1">
                        <div id="exp-u" dir="ltr" class="text-2xl font-black mb-1 break-all leading-tight text-left"></div>
                        <div id="exp-i" class="text-sm text-slate-400 font-mono tracking-wider"></div>
                    </div>
                </div>

                <div id="exp-tags" class="flex flex-wrap gap-2 mb-6"></div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-950/50 rounded-xl p-4 border border-white/5">
                        <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Device</div>
                        <div id="exp-d" dir="ltr" class="font-bold text-slate-200 text-xs break-words leading-snug text-left"></div>
                    </div>
                    <div class="bg-slate-950/50 rounded-xl p-4 border border-white/5">
                        <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Created At</div>
                        <div id="exp-c" dir="ltr" class="font-bold text-slate-200 text-left"></div>
                    </div>
                     <div class="col-span-2 bg-slate-950/50 rounded-xl p-4 border border-white/5">
                        <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Location / Signal</div>
                        <div id="exp-l" dir="ltr" class="font-bold text-slate-200 text-left"></div>
                    </div>
                </div>
            </div>

            <div class="relative z-10 mt-8 text-center opacity-50">
                <div class="text-[10px] tracking-[0.3em] uppercase mb-2">Security Analysis Report</div>
                <div class="w-24 h-1 bg-gradient-to-r from-transparent via-white/50 to-transparent mx-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const DB_URL = "https://raw.githubusercontent.com/itsyebekhe/xforensics/main/database.json";
        const VIDEO_URL = "https://raw.githubusercontent.com/itsyebekhe/xforensics/refs/heads/main/xforensics%20tutorial.mp4";
        const ITEMS_PER_PAGE = 30;
        const PERSIAN_NUMS = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        const ENGLISH_NUMS = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

        // --- STATE ---
        let fullDatabase = {}; // Stores the RAW DB
        let allData = []; // Stores filtered anomalies for the main list
        let filteredData = []; // Stores the current search result for the list
        let currentPage = 1;
        let currentView = 'list';

        // --- UTILS ---
        const toEnglishDigits = (str) => {
            return str.replace(/[۰-۹]/g, w => ENGLISH_NUMS[PERSIAN_NUMS.indexOf(w)]);
        };

        const toggleTutorial = (show) => {
            const modal = document.getElementById('tutorial-modal');
            const video = document.getElementById('tutorial-video');
            
            if (show) {
                modal.classList.remove('hidden');
                // Lazy Load Source
                if (!video.src) {
                     video.src = VIDEO_URL;
                }
                video.play().catch(e => console.log('Autoplay prevented'));
            } else {
                modal.classList.add('hidden');
                video.pause();
                // Optional: Stop download completely
                video.src = ""; 
                video.load();
            }
        };

        // --- INIT ---
        async function init() {
            try {
                const response = await fetch(`${DB_URL}?t=${Date.now()}`);
                const json = await response.json();
                processData(json);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
            } catch (error) {
                console.error("Error loading DB:", error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500 font-bold">خطا در دریافت دیتابیس.</p>`;
            }
        }

        function processData(rawData) {
            fullDatabase = rawData; // STORE RAW DATA GLOBALLY
            allData = [];
            let stats = { total: 0, android: 0, iphone: 0, web: 0 };

            for (const [username, info] of Object.entries(rawData)) {
                const d = info.data;
                if (!d) continue;

                const loc = d.countryCode || "";
                const isAccurate = d.isAccurate || false;
                const isTarget = (loc === "Iran" || loc === "West Asia");

                if (isTarget && isAccurate === true) {
                    stats.total++;
                    const dev = d.device || "";
                    if (dev.toLowerCase().includes("android")) stats.android++;
                    else if (dev.toLowerCase().includes("iphone")) stats.iphone++;
                    else stats.web++;

                    allData.push({
                        u: username,
                        i: d.id || "0",
                        a: d.avatar || "",
                        d: d.device || "Unknown",
                        l: d.country || loc,
                        c: d.created || "-",
                        tags: info.tags || [],
                        risk: d.riskLabel || "ANOMALY",
                        norm_date: toEnglishDigits(d.created || "")
                    });
                }
            }
            updateHeaderStats(stats);
            renderAnalytics(stats);
            filterList();
        }

        // --- HEADER & ANALYTICS RENDER ---
        function updateHeaderStats(stats) {
            document.getElementById('header-stat-total').textContent = stats.total.toLocaleString('fa-IR');
            document.getElementById('header-stat-android').textContent = stats.android.toLocaleString('fa-IR');
            document.getElementById('header-stat-iphone').textContent = stats.iphone.toLocaleString('fa-IR');
        }

        function renderAnalytics(stats) {
            // Stats Grid
            document.getElementById('anl-total').textContent = stats.total.toLocaleString('fa-IR');
            document.getElementById('anl-android').textContent = stats.android.toLocaleString('fa-IR');
            document.getElementById('anl-iphone').textContent = stats.iphone.toLocaleString('fa-IR');
            document.getElementById('anl-web').textContent = stats.web.toLocaleString('fa-IR');

            // Bar Chart
            const t = stats.total || 1;
            const pA = Math.round((stats.android / t) * 100);
            const pI = Math.round((stats.iphone / t) * 100);
            const pW = Math.round((stats.web / t) * 100);

            document.getElementById('bar-android-pct').style.width = pA + '%';
            document.getElementById('bar-iphone-pct').style.width = pI + '%';
            document.getElementById('bar-web-pct').style.width = pW + '%';
            
            document.getElementById('lbl-android').textContent = pA + '% Android';
            document.getElementById('lbl-iphone').textContent = pI + '% iPhone';
            document.getElementById('lbl-web').textContent = pW + '% Web';

            // Clusters (Group by Date)
            const dateCounts = {};
            const years = {};

            allData.forEach(item => {
                const dateOnly = item.norm_date.split(/[\s,]+/)[0];
                if(dateOnly) dateCounts[dateOnly] = (dateCounts[dateOnly] || 0) + 1;

                const yMatch = item.norm_date.match(/(\d{4})/);
                if(yMatch) {
                    const y = yMatch[1];
                    if(parseInt(y) > 1300) years[y] = (years[y] || 0) + 1;
                }
            });

            // Render Clusters (>= 3 items)
            let clusterHtml = '';
            Object.entries(dateCounts)
                .filter(([_, count]) => count >= 3)
                .sort((a, b) => b[1] - a[1]) // Sort desc
                .slice(0, 12)
                .forEach(([date, count]) => {
                    clusterHtml += `
                    <div onclick="filterByDate('${date}')" class="bg-red-900/10 border border-red-900/30 rounded-lg p-3 text-center hover:bg-red-900/30 transition-all cursor-pointer group">
                        <div class="text-[10px] text-slate-400 font-mono mb-1">${date}</div>
                        <div class="font-black text-xl text-red-400 group-hover:scale-110 transition-transform">${count}</div>
                    </div>`;
                });
            document.getElementById('clusters-grid').innerHTML = clusterHtml || '<div class="col-span-full text-slate-500 text-sm">داده کافی نیست</div>';

            // Render Timeline
            let timelineHtml = '';
            const maxYearCount = Math.max(...Object.values(years), 1);
            Object.keys(years).sort().forEach(year => {
                const count = years[year];
                const h = Math.max(Math.round((count / maxYearCount) * 100), 5);
                timelineHtml += `
                <div class='h-full flex flex-col justify-end items-center w-10 flex-shrink-0 group relative'>
                    <div class='absolute bottom-full mb-1 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-800 text-white text-[10px] py-1 px-2 rounded z-20 shadow-xl font-mono'>${count}</div>
                    <div class='w-full bg-blue-600 rounded-t-md relative group-hover:bg-blue-400 transition-all shadow-sm group-hover:shadow-lg shadow-blue-500/20' style='height: ${h}%;'></div>
                    <div class='text-[10px] text-slate-400 mt-2 font-mono'>${year}</div>
                </div>`;
            });
            document.getElementById('timeline-chart').innerHTML = timelineHtml;
        }

        // --- LIST VIEW LOGIC ---
        function filterByDate(date) {
            document.getElementById('search-input').value = date;
            switchView('list');
            filterList();
        }

        function filterList() {
            const query = toEnglishDigits(document.getElementById('search-input').value.toLowerCase());
            const sort = document.getElementById('sort-select').value;

            filteredData = allData.filter(item => 
                item.u.toLowerCase().includes(query) || 
                item.i.includes(query) ||
                item.norm_date.includes(query)
            );

            // Sort logic based on ID length (proxy for age)
            filteredData.sort((a, b) => {
                if (sort === 'oldest') {
                    return a.i.length - b.i.length || a.i.localeCompare(b.i);
                } else {
                    return b.i.length - a.i.length || b.i.localeCompare(a.i);
                }
            });

            currentPage = 1;
            renderList();
        }

        function renderList() {
            const container = document.getElementById('results-grid');
            container.innerHTML = "";
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const items = filteredData.slice(start, end);

            if (items.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-12 text-slate-500 border border-dashed border-slate-800 rounded-2xl font-bold">موردی یافت نشد.</div>`;
                renderPagination(0);
                return;
            }

            items.forEach(user => {
                const avatar = user.a || "/assets/images/placeholder.png";
                const riskColor = user.d.toLowerCase().includes('android') ? 'bg-red-500' : 'bg-orange-500';
                
                const card = `
                <div class="group relative bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden hover:border-slate-600 transition-all hover:-translate-y-1 duration-300 animate-fade-in-up">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 ${riskColor} opacity-70"></div>
                    <div class="p-5 pl-7">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <img src="${avatar}" class="w-12 h-12 rounded-xl object-cover ring-2 ring-slate-800 shadow-sm cursor-zoom-in" loading="lazy" onerror="this.src='https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png'" onclick="openLightbox('${avatar}')">
                                <div class="min-w-0 text-right">
                                    <a href="https://x.com/${user.u}" target="_blank" dir="ltr" class="block font-black text-lg text-white hover:text-blue-500 truncate font-sans text-left">@${user.u}</a>
                                    <div class="font-mono text-[10px] text-slate-400 select-all">${user.i}</div>
                                </div>
                            </div>
                            <div class="px-2 py-1 rounded text-[10px] font-bold border border-slate-700 bg-slate-800 text-slate-400">${user.risk}</div>
                        </div>
                        <div class="space-y-2 mb-5">
                            <div class="flex items-center justify-between text-xs"><span class="text-slate-400">تاریخ ساخت</span><span class="font-medium text-slate-300 font-sans" dir="ltr">${user.c}</span></div>
                            <div class="flex items-center justify-between text-xs"><span class="text-slate-400">دستگاه</span><span class="font-medium text-slate-300 truncate max-w-[150px]" dir="ltr">${user.d}</span></div>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <a href="https://web.archive.org/web/*/twitter.com/${user.u}" target="_blank" class="py-2 rounded-lg bg-slate-800 text-slate-500 hover:bg-blue-900/30 hover:text-blue-500 transition-colors text-center text-xs font-bold">آرشیو</a>
                            <a href="https://www.google.com/search?q=%22${user.u}%22+site:twitter.com" target="_blank" class="py-2 rounded-lg bg-slate-800 text-slate-500 hover:bg-green-900/30 hover:text-green-500 transition-colors text-center text-xs font-bold">گوگل</a>
                            <a href="https://lens.google.com/upload?url=${encodeURIComponent(avatar)}" target="_blank" class="py-2 rounded-lg bg-slate-800 text-slate-500 hover:bg-orange-900/30 hover:text-orange-500 transition-colors text-center text-xs font-bold">لنز</a>
                            <button onclick='prepareReport(${JSON.stringify(user)})' class="py-2 rounded-lg bg-slate-800 text-slate-500 hover:bg-purple-900/30 hover:text-purple-500 transition-colors flex items-center justify-center">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            </button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += card;
            });
            renderPagination(Math.ceil(filteredData.length / ITEMS_PER_PAGE));
        }

        function renderPagination(totalPages) {
            const el = document.getElementById('pagination');
            if (totalPages <= 1) { el.innerHTML = ''; return; }
            el.innerHTML = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled class="opacity-30"' : 'class="px-4 py-2 bg-slate-800 rounded-lg hover:bg-blue-600 text-white transition-colors"'} >&rarr; قبلی</button>
                <span class="mx-2 bg-slate-900 px-3 py-1 rounded-lg">${currentPage} / ${totalPages}</span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled class="opacity-30"' : 'class="px-4 py-2 bg-slate-800 rounded-lg hover:bg-blue-600 text-white transition-colors"'} >بعدی &larr;</button>
            `;
        }

        function changePage(p) { currentPage = p; renderList(); document.getElementById('view-list').scrollIntoView({ behavior: 'smooth' }); }

        // --- LOOKUP VIEW LOGIC (UPDATED) ---
        function performLookup() {
            const query = toEnglishDigits(document.getElementById('lookup-input').value.toLowerCase().trim());
            const container = document.getElementById('lookup-result');
            
            if(!query) return;

            let foundRaw = null;
            let foundUsername = "";

            // Search in global fullDatabase
            for (const [key, value] of Object.entries(fullDatabase)) {
                if (key.toLowerCase() === query || (value.data && value.data.id === query)) {
                    foundRaw = value;
                    foundUsername = key;
                    break;
                }
            }
            
            if(foundRaw && foundRaw.data) {
                const d = foundRaw.data;
                // Prepare object for display
                const found = {
                    u: foundUsername,
                    i: d.id || "0",
                    a: d.avatar || "",
                    d: d.deviceFull || d.device || "Unknown",
                    l: d.country || d.countryCode || "Unknown",
                    c: d.created || "-",
                    tags: foundRaw.tags || [],
                    risk: d.riskLabel || "INFO"
                };

                const avatar = found.a || "/assets/images/placeholder.png";
                const riskColor = found.d.toLowerCase().includes('android') ? 'bg-red-500' : (found.risk === "ANOMALY" ? 'bg-orange-500' : 'bg-blue-500');
                
                container.innerHTML = `
                <div class="group relative bg-slate-900 rounded-3xl border border-slate-800 overflow-hidden shadow-2xl animate-fade-in-up mt-8">
                    <div class="absolute left-0 top-0 bottom-0 w-2 ${riskColor} opacity-80"></div>
                    <div class="p-8 pl-10">
                         <div class="flex justify-between items-start mb-6">
                            <div class="flex items-center gap-4">
                                <img src="${avatar}" class="w-16 h-16 rounded-2xl object-cover ring-4 ring-slate-800 shadow-lg" onerror="this.src='https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png'">
                                <div class="min-w-0 text-right">
                                    <a href="https://x.com/${found.u}" target="_blank" dir="ltr" class="block font-black text-2xl text-white hover:text-blue-500 truncate font-sans text-left">@${found.u}</a>
                                    <div class="font-mono text-xs text-slate-400 select-all">${found.i}</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-6 flex justify-center">
                            <span class="px-4 py-1.5 rounded-full text-xs font-black tracking-wider border border-slate-700 bg-slate-800 text-slate-300">${found.risk}</span>
                        </div>
                        <div class="space-y-4 mb-8">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-slate-950/50 rounded-xl p-4 border border-slate-800">
                                    <span class="block text-xs text-slate-400 mb-1">تاریخ ساخت</span>
                                    <span class="block font-bold text-slate-200 font-mono text-sm" dir="ltr">${found.c}</span>
                                </div>
                                <div class="bg-slate-950/50 rounded-xl p-4 border border-slate-800">
                                    <span class="block text-xs text-slate-400 mb-1">موقعیت</span>
                                    <span class="block font-bold text-slate-200 dir-ltr text-sm">${found.l}</span>
                                </div>
                            </div>
                             <div class="bg-slate-950/50 rounded-xl p-4 border border-slate-800">
                                <span class="block text-xs text-slate-400 mb-1">دستگاه</span>
                                <span class="block font-bold text-slate-200 dir-ltr text-sm">${found.d}</span>
                            </div>
                        </div>
                        <button onclick='prepareReport(${JSON.stringify(found)})' class="w-full py-3 rounded-xl bg-slate-800 text-white hover:bg-slate-700 transition-colors flex items-center justify-center gap-2 font-bold shadow-lg shadow-slate-900/20">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            دریافت تصویر گزارش
                        </button>
                    </div>
                </div>`;
            } else {
                container.innerHTML = `<div class="mt-8 p-6 bg-red-900/10 border border-red-900/30 rounded-2xl text-center text-red-400 font-bold animate-fade-in-up">کاربری با این مشخصات یافت نشد.</div>`;
            }
        }

        // --- REPORT GENERATION (CANVAS) ---
        function prepareReport(data) {
            const tpl = document.getElementById('export-template');
            
            document.getElementById('exp-u').innerText = '@' + data.u;
            document.getElementById('exp-i').innerText = data.i;
            document.getElementById('exp-d').innerText = data.d;
            document.getElementById('exp-c').innerText = data.c;
            document.getElementById('exp-l').innerText = data.l;
            document.getElementById('exp-r').innerText = data.risk;
            
            // Tags rendering
            const tagMap = {
                'loc_change': { label: 'Location Changed', color: 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30' },
                'base_iran': { label: 'Suspect Base Iran', color: 'bg-red-500/20 text-red-300 border-red-500/30' },
                'cyber': { label: 'Cyber/Organized', color: 'bg-purple-500/20 text-purple-300 border-purple-500/30' },
                'fake': { label: 'Fake/Bot', color: 'bg-slate-500/20 text-slate-300 border-slate-500/30' }
            };
            let tagsHtml = '';
            (data.tags || []).forEach(t => {
                if(tagMap[t]) tagsHtml += `<span class="px-2 py-1 rounded text-[10px] font-bold border ${tagMap[t].color} uppercase tracking-wider">${tagMap[t].label}</span>`;
            });
            document.getElementById('exp-tags').innerHTML = tagsHtml;

            // Image handling (Proxy for CORS usually needed, simplified here)
            const imgEl = document.getElementById('exp-a');
            imgEl.src = data.a || "https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png";
            
            // Wait for image load then capture
            setTimeout(() => {
                html2canvas(tpl, {
                    useCORS: true,
                    allowTaint: false,
                    scale: 2,
                    backgroundColor: '#020617',
                    width: 600,
                    height: 600
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `xf-report-${data.u}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }).catch(err => {
                    alert("خطا در تولید تصویر. ممکن است به دلیل محدودیت‌های مرورگر (CORS) باشد.");
                    console.error(err);
                });
            }, 500);
        }

        // --- NAVIGATION & UI ---
        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Update Tab styles
            ['list', 'analytics', 'lookup'].forEach(v => {
                const btn = document.getElementById(`tab-${v}`);
                if(v === viewName) {
                    btn.classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                    btn.classList.add('bg-slate-800', 'text-white', 'shadow-sm');
                } else {
                    btn.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                    btn.classList.remove('bg-slate-800', 'text-white', 'shadow-sm');
                }
            });
        }

        function exportCSV() {
            if (filteredData.length === 0) return alert("داده‌ای برای دانلود موجود نیست.");
            let csv = "\uFEFFUsername,ID,Location,Device,Created,Link\n";
            filteredData.forEach(u => {
                csv += `${u.u},${u.i},${u.l},"${u.d}",${u.c},https://x.com/${u.u}\n`;
            });
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `xforensics_export_${Date.now()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- LISTENERS ---
        document.getElementById('search-input').addEventListener('input', filterList);
        document.getElementById('sort-select').addEventListener('change', filterList);
        document.getElementById('lookup-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performLookup();
        });

        // Close lightbox on ESC
        window.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeLightbox(); });
        
        // --- LIGHTBOX FUNCTIONS ---
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');

        function openLightbox(src) {
            const highRes = src.replace("_normal", "_orig").replace("_400x400", "_orig");
            lightboxImg.src = highRes;
            lightbox.classList.remove('hidden');
            setTimeout(() => {
                lightbox.classList.remove('opacity-0');
                lightboxImg.classList.remove('scale-95');
                lightboxImg.classList.add('scale-100');
            }, 10);
            document.body.style.overflow = 'hidden'; 
        }

        function closeLightbox() {
            lightbox.classList.add('opacity-0');
            lightboxImg.classList.remove('scale-100');
            lightboxImg.classList.add('scale-95');
            setTimeout(() => {
                lightbox.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }
        
        lightbox.addEventListener('click', (e) => { if(e.target === lightbox) closeLightbox(); });

        // Start App
        init();

    </script>
</body>
</html>
